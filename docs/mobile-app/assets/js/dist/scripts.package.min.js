var TVMaze_API=function(){this.cache={},this.lastRequest=!1,this.lastResponse=!1};TVMaze_API.prototype.setCache=function(e,t){var s=(new Date).getTime();this.cache[e]={response:t,setAt:s},localStorage.setItem(e,JSON.stringify(this.cache[e]))},TVMaze_API.prototype.getCache=function(e){var t=(new Date).getTime();if(this.cache.hasOwnProperty(e)&&this.cache[e].setAt<t-300)return this.cache[e].response;if(localStorage.getItem(e)){var s=JSON.parse(localStorage.getItem(e));if(s.setAt<t-300)return s.response}return!1},TVMaze_API.prototype.removeExpiredCache=function(){},TVMaze_API.prototype.get=function(e,t){var s=this._request(),o=this,n=!1;if(!1===s)return!1;this.lastRequest=e;var i=this.getCache(e);return!1!==i?t(o,i):(s.open("GET","https://api.tvmaze.com/"+e,!0),s.send(),s.addEventListener("load",function(){n=JSON.parse(s.responseText),o.setCache(e,n),this.lastResponse=n,t(o,n)},!1),s.addEventListener("error",function(){n=JSON.parse(s.responseText),this.lastResponse=n,t(o,n)},!1),this)},TVMaze_API.prototype._request=function(){return!!window.XMLHttpRequest&&new XMLHttpRequest},(TVMaze_Controller=function(e){this.view=e.view,this.api=e.api,this.shows=[],this.currentShowId=null,this.currentSeasonId=null,this.currentEpisodeId=null;var o=this;window.onload=function(){document.getElementById("submit-search-shows")&&document.getElementById("submit-search-shows").addEventListener("click",function(e){e.preventDefault();var t=document.getElementById("input-search-shows").value;""!==t&&this.getShowsBySearch(t,function(e){for(showsHTML="",s=0;s<e.length;s++)showsHTML+='<li class="show-item" data-id="'+e[s].id+'" data-index="'+s+'">'+e[s].title+"</li>";o.view.draw("view-shows",{shows:showsHTML,search:t})})}),document.addEventListener("click",function(e){"show-item"===e.srcElement.className&&(show=o.getShowById(e.srcElement.getAttribute("data-id")),o.view.draw("view-show",{title:show.title,image:show.image,description:show.description,onAir:show.onAir?"Yes":"No"}))})}}).prototype.getShowsBySearch=function(e,n){self.api.get("search/show?q="+encodeURI(e),function(e,t){if(t&&0<t.length){var s=[],o=0;for(o=0;o<t.length;o++)s.push(new TVMaze_Model_Show(t[o].show));n(s)}else n([])})},TVMaze_Controller.prototype.getShowById=function(e){if(null===this.shows)return!1;var t=this.getItemByNameValue(this.shows,"id",e);return t||!1},TVMaze_Controller.prototype.getSeasons=function(){var e=this.getShowById(this.currentShowId);return!(!e||!e.hasOwnProperty("seasons"))&&e.seasons},TVMaze_Controller.prototype.getSeasonById=function(e,t){if(null===e||!e.hasOwnProperty("seasons")||0===e.seasons.length)return!1;var s=this.getItemByNameValue(this.show.seasons,"id",t);return s||!1},TVMaze_Controller.prototype.getEpisodes=function(){var e=this.getShowById(this.currentShowId);if(!e||e.hasOwnProperty("seasons")||0===e.seasons.length)return!1;var t=this.getSeasonById(e,this.currentSeasonId);return!(!t||!t.hasOwnProperty("episodes"))&&t.episodes},TVMaze_Controller.prototype.getEpisodeById=function(e,t){if(null===show||!show.hasOwnProperty("seasons")||0===show.seasons.length)return!1;var s=this.getItemByNameValue(e.episodes,"id",t);return s||!1},TVMaze_Controller.prototype.getItemByNameValue=function(e,t,s){var o=jQuery.grep(e,function(e){return e[t]===s});return 0<o.length&&o[0]};var TVMaze_View=function(e){this.templates={}};TVMaze_View.prototype.draw=function(e,t){t=t&&"object"==typeof t?t:{};var s=this._template(e,t);document.getElementsByTagName("main")[0].innerHTML=s},TVMaze_View.prototype._template=function(e,t){var s=this.templates.hasOwnProperty(e)?this.templates[e]:document.getElementById("template-"+e).innerHTML;if(s)for(var o in t)t.hasOwnProperty(o)&&void 0!==t[o]&&(s=this._replaceAll(s,"{{ "+o+" }}",t[o]));return this._replaceAll(s,"{{.*}}","",!1)},TVMaze_View.prototype._escapeRegExp=function(e){return e.replace(/([.*+?^=!:${}()|\[\]\/\\])/g,"\\$1")},TVMaze_View.prototype._replaceAll=function(e,t,s,o){return null===s&&(s=""),void 0!==o&&!1!==o&&(t=this._escapeRegExp(t)),void 0!==e&&""!==e&&e.replace(new RegExp(t,"g"),s)};var TVMaze_Interface_Model_API=function(){this.baseQuery=null};TVMaze_Interface_Model_API.prototype.get=function(e,t){return e=this.baseQuery+e,(new TVMaze_API).get(e,t)};var TVMaze_Model_Episode=function(){TVMaze_Interface_Model_API.call(this),this.baseQuery="episodes/"},TVMaze_Model_Season=function(e){TVMaze_Interface_Model_API.call(this),this.baseQuery="seasons/",this.id=e,this.episodes=[]};TVMaze_Model_Season.prototype.getId=function(){return this.id},TVMaze_Model_Season.prototype.setId=function(e){return this.id=e,this},TVMaze_Model_Season.prototype.getEpisodes=function(){if(this.id=id,this.episodes)return this.episodes;var e=this.get(this.baseQuery+this.id+"/episodes");if(e&&0<e.length)for(var t=0;t<e.length;t++)this.episodes.push(new TVMaze_Model_Episode(e[t]));return this.episodes};var TVMaze_Model_Show=function(e){TVMaze_Interface_Model_API.call(this),this.baseQuery="shows/",this.seasons=!1,this.id=e.id,this.images=e.images,this.title=e.name,this.description=e.summary,this.onAir="Running"===e.status};TVMaze_Model_Show.prototype.getSeasons=function(){this.seasons};var TVMaze_Controller,containerID="tv-maze-container";(TVMaze_Controller=new TVMaze_Controller({containerID:containerID,view:new TVMaze_View,api:new TVMaze_API})).view.draw("view-index");