var TVMaze_API=function(){this.cache={}};TVMaze_API.prototype.setCache=function(e,t){var s=(new Date).getTime();this.cache[e]={response:t,setAt:s},localStorage.setItem(e,JSON.stringify(this.cache[e]))},TVMaze_API.prototype.getCache=function(e){var t=(new Date).getTime();if(this.cache.hasOwnProperty(e)&&this.cache[e].setAt<t-300)return this.cache[e].response;if(localStorage.getItem(e)){var s=JSON.parse(localStorage.getItem(e));if(s.setAt<t-300)return s.response}return!1},TVMaze_API.prototype.removeExpiredCache=function(){},TVMaze_API.prototype.get=function(e,t){var s=this._request(),a=this,i=!1;if(!1===s)return!1;this.lastRequest=e;var n=this.getCache(e);return!1!==n?t(a,n):(s.open("GET","https://api.tvmaze.com/"+e,!0),s.send(),s.addEventListener("load",function(){i=JSON.parse(s.responseText),a.setCache(e,i),this.lastResponse=i,t(a,i)},!1),s.addEventListener("error",function(){i=JSON.parse(s.responseText),this.lastResponse=i,t(a,i)},!1),this)},TVMaze_API.prototype._request=function(){return!!window.XMLHttpRequest&&new XMLHttpRequest};var TVMaze_Controller=function(e){this.view=e.view,this.api=e.api,this.shows=[];var a=this;window.onload=function(){document.getElementById("submit-search-shows")&&document.getElementById("submit-search-shows").addEventListener("click",function(e){a.shows=[],e.preventDefault();var t=document.getElementById("input-search-shows").value;""!==t&&a.getShowsBySearch(t,function(e){for(showsHTML="",s=0;s<e.length;s++)showsHTML+='<li class="show-item" data-id="'+e[s].id+'" data-index="'+s+'">'+e[s].title+"</li>";a.shows=e,a.view.draw("view-shows",{shows:showsHTML,search:t})})}),document.addEventListener("click",function(e){"show-item"===e.srcElement.className&&(show=a.getShowById(e.srcElement.getAttribute("data-id")),show.getSeasons(function(){a.view.draw("view-show",show)}))}),document.getElementById("navigation-previous").addEventListener("click",function(e){a.view.drawPrevious()})}};TVMaze_Controller.prototype.getShowsBySearch=function(e,i){this.api.get("search/shows?q="+encodeURI(e),function(e,t){if(t&&0<t.length){for(var s=[],a=0;a<t.length;a++)s.push(new TVMaze_Model_Show(t[a].show));i(s)}else i([])})},TVMaze_Controller.prototype.getShowById=function(e){if(null===this.shows)return!1;var t=this.getItemByNameValue(this.shows,"id",e);return t||!1},TVMaze_Controller.prototype.getItemByNameValue=function(e,t,s){for(var a=0;a<e.length;a++)for(var i in e[a])if(i===t&&e[a][i]==s)return e[a];return!1};var TVMaze_View=function(e){this.templates={},this.history=[],this.current=null};TVMaze_View.prototype.drawPrevious=function(){if(null!==this.current&&0<this.history.length)for(var e=!0,t=null;e;)(t=this.history.pop()).templateID!==this.current&&(this.draw(t.templateID,t.params),e=!1)},TVMaze_View.prototype.draw=function(e,t){t=t&&"object"==typeof t?t:{};var s=this._template(e,t);document.getElementsByTagName("main")[0].innerHTML=s,this.current=e,this.history.push({templateID:e,params:t})},TVMaze_View.prototype._template=function(templateID,params){var template=this.templates.hasOwnProperty(templateID)?this.templates[templateID]:document.getElementById("template-"+templateID).innerHTML;if(template){for(var regex=/\{\{\s([a-z.]+)\s\}\}/gim,variables=[];null!==(match=regex.exec(template));)variables.push(match[1]);var replacementValue=null;if(variables&&0<variables.length)for(var v=0;v<variables.length;v++)eval("replacementValue = (typeof params."+variables[v]+' !== "undefined" ) ? params.'+variables[v]+' : "";'),template=this._replaceAll(template,"{{ "+variables[v]+" }}",replacementValue)}return this._replaceAll(template,"{{.*}}","",!1)},TVMaze_View.prototype._escapeRegExp=function(e){return e.replace(/([.*+?^=!:${}()|\[\]\/\\])/g,"\\$1")},TVMaze_View.prototype._replaceAll=function(e,t,s,a){return null===s&&(s=""),void 0!==a&&!1!==a&&(t=this._escapeRegExp(t)),void 0!==e&&""!==e&&e.replace(new RegExp(t,"g"),s)};var TVMaze_Interface_Model_API=function(){this.baseQuery=null};TVMaze_Interface_Model_API.prototype.get=function(e,t){return e=this.baseQuery+e,(new TVMaze_API).get(e,t)};var TVMaze_Model_Episode=function(e,t,s){this.id=s.id,this.showId=e,this.seasonId=t,this.number=s.number,this.title=""!==s.name?s.name:s.number,this.images=s.image,this.premierDate=s.airDate,this.length=s.runtime,this.description=epsidoe.summary,this.baseQuery="seasons/"+this.seasonId+"/episodes/"+this.id+"/"},TVMaze_Model_Season=function(e,t){this.episodes=!1,this.id=t.id,this.showId=e,this.number=t.number,this.title=""!==t.name?t.name:t.number,this.premierDate=t.premierDate,this.endDate=t.endDate,this.description=t.summary,this.baseQuery="shows/"+this.showId+"/seasons/"+this.id+"/"};TVMaze_Model_Season.prototype.getEpisodes=function(a){var i=this;this.hasOwnProperty("episodes")&&!1!==this.episodes?a(this.episodes):!1===this.episodes&&TVMaze_Controller_Instance.api.get(this.baseQuery+"episodes",function(e,t){if(i.episodes=[],t&&0<t.length)for(var s=0;s<t.length;s++)i.seasons.push(new TVMaze_Model_Episode(i.showId,i.id,t[s]));a(i.episodes)})};var TVMaze_Model_Show=function(e){TVMaze_Interface_Model_API.call(this),this.seasons=!1,this.id=e.id,this.images=e.image,this.title=e.name,this.description=e.summary,this.status=e.status,this.rating=e.rating,this.premierDate=e.premiered,this.baseQuery="shows/"+this.id+"/"};TVMaze_Model_Show.prototype.getSeasons=function(a){var i=this;this.hasOwnProperty("seasons")&&!1!==this.seasons?a(this.seasons):!1===this.seasons&&TVMaze_Controller_Instance.api.get(this.baseQuery+"seasons",function(e,t){if(i.seasons=[],t&&0<t.length)for(var s=0;s<t.length;s++)i.seasons.push(new TVMaze_Model_Season(i.id,t[s]));a(i.seasons)})},TVMaze_Model_Show.prototype.getSeasonById=function(e){if(!this.hasOwnProperty("seasons")||0===this.seasons.length)return!1;var t=this.getItemByNameValue(this.seasons,"id",e);return t||!1};var containerID="tv-maze-container",TVMaze_Controller_Instance=new TVMaze_Controller({containerID:containerID,view:new TVMaze_View,api:new TVMaze_API});TVMaze_Controller_Instance.view.draw("view-index");