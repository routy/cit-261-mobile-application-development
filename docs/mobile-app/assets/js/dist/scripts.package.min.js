var TVMaze_API=function(){this.cache={}};TVMaze_API.prototype.setCache=function(e,t){var s=(new Date).getTime();this.cache[e]={response:t,setAt:s},localStorage.setItem(e,JSON.stringify(this.cache[e]))},TVMaze_API.prototype.getCache=function(e){var t=(new Date).getTime();if(this.cache.hasOwnProperty(e)&&this.cache[e].setAt<t-300)return this.cache[e].response;if(localStorage.getItem(e)){var s=JSON.parse(localStorage.getItem(e));if(s.setAt<t-300)return s.response}return!1},TVMaze_API.prototype.removeExpiredCache=function(){},TVMaze_API.prototype.get=function(e,t){TVMaze_Controller_Instance.view.loading(!0);var s=this._request(),i=this,a=!1;if(!1===s)return TVMaze_Controller_Instance.view.loading(!1),!1;this.lastRequest=e;var n=this.getCache(e);return!1!==n?(t(i,n),void TVMaze_Controller_Instance.view.loading(!1)):(s.open("GET","https://api.tvmaze.com/"+e,!0),s.send(),s.addEventListener("load",function(){a=JSON.parse(s.responseText),i.setCache(e,a),this.lastResponse=a,t(i,a),TVMaze_Controller_Instance.view.loading(!1)},!1),s.addEventListener("error",function(){a=JSON.parse(s.responseText),this.lastResponse=a,t(i,a),TVMaze_Controller_Instance.view.loading(!1)},!1),this)},TVMaze_API.prototype._request=function(){return!!window.XMLHttpRequest&&new XMLHttpRequest};var TVMaze_Controller=function(e){this.view=e.view,this.api=e.api,this.shows=[];var i=this;window.onload=function(){document.getElementById("submit-search-shows")&&document.getElementById("submit-search-shows").addEventListener("click",function(e){i.shows=[],e.preventDefault();var t=document.getElementById("input-search-shows").value;""!==t&&i.getShowsBySearch(t,function(e){if(showsHTML="",0<e.length){for(showsHTML+='<ul id="shows-list">',s=0;s<e.length;s++)showsHTML+='<li class="show-item" data-id="'+e[s].id+'" data-index="'+s+'">',showsHTML+='<div class="flex-grid-gutter">',showsHTML+='<div class="col col-1-4">',showsHTML+='<span class="show-item-img" ',e[s].images&&void 0!==e[s].images.medium?showsHTML+='style="background-image: url('+e[s].images.medium+');"':showsHTML+='style="background-image: url(assets/img/show-image-unavailable-medium.jpg);"',showsHTML+="></span>",showsHTML+="</div>",showsHTML+='<div class="col col-3-4">',e[s].genre&&void 0!==e[s].genre&&(showsHTML+='<span class="show-item-genre">'+e[s].genre+"</span>"),showsHTML+='<span class="show-item-title">'+e[s].title+"</span>",e[s].network&&void 0!==e[s].network.name&&(showsHTML+='<span class="show-item-network">'+e[s].network.name+" ("+e[s].network.country.code+")</span>"),showsHTML+="</div>",showsHTML+="</div>",showsHTML+="</li>";showsHTML+="</ul>",i.shows=e}else showsHTML="<p>No matching shows were found.</p>";i.view.draw("view-shows",{shows:showsHTML,search:t})})}),document.addEventListener("click",function(e){"show-item"===e.srcElement.className?showItem=e.srcElement:showItem=e.srcElement.closest(".show-item"),showItem&&(show=i.getShowById(showItem.getAttribute("data-id")),show&&show.getSeasons(function(){i.view.draw("view-show",show)}))}),document.getElementById("navigation-previous").addEventListener("click",function(e){i.view.drawPrevious()})}};TVMaze_Controller.prototype.getShowsBySearch=function(e,a){this.api.get("search/shows?q="+encodeURI(e),function(e,t){if(t&&0<t.length){for(var s=[],i=0;i<t.length;i++)s.push(new TVMaze_Model_Show(t[i].show));a(s)}else a([])})},TVMaze_Controller.prototype.getShowById=function(e){if(null===this.shows)return!1;var t=this.getItemByNameValue(this.shows,"id",e);return t||!1},TVMaze_Controller.prototype.getItemByNameValue=function(e,t,s){for(var i=0;i<e.length;i++)for(var a in e[i])if(a===t&&e[i][a]==s)return e[i];return!1};var TVMaze_View=function(e){this.templates={},this.history=[],this.current=null};TVMaze_View.prototype.drawPrevious=function(){if(null!==this.current&&0<this.history.length)for(var e=!0,t=null;e;)(t=this.history.pop()).templateID!==this.current&&(this.draw(t.templateID,t.params),e=!1)},TVMaze_View.prototype.draw=function(e,t){t=t&&"object"==typeof t?t:{};try{var s=this._template(e,t);document.getElementsByTagName("main")[0].innerHTML=s,this.current=e,this.history.push({templateID:e,params:t}),1<this.history.length?document.getElementById("navigation-previous").style.display="inline-block":document.getElementById("navigation-previous").style.display="none",window.scrollTo(0,0)}catch(e){return}},TVMaze_View.prototype._template=function(templateID,params){var template=this.templates.hasOwnProperty(templateID)?this.templates[templateID]:document.getElementById("template-"+templateID).innerHTML;if(template){for(var regex=/\{\{\s([a-z.]+)\s\}\}/gim,variables=[];null!==(match=regex.exec(template));)variables.push(match[1]);var replacementValue=null;if(variables&&0<variables.length)for(var v=0;v<variables.length;v++)eval("replacementValue = (typeof params."+variables[v]+' !== "undefined" ) ? params.'+variables[v]+' : "";'),template=this._replaceAll(template,"{{ "+variables[v]+" }}",replacementValue)}return this._replaceAll(template,"{{.*}}","",!1)},TVMaze_View.prototype._escapeRegExp=function(e){return e.replace(/([.*+?^=!:${}()|\[\]\/\\])/g,"\\$1")},TVMaze_View.prototype._replaceAll=function(e,t,s,i){return null===s&&(s=""),void 0!==i&&!1!==i&&(t=this._escapeRegExp(t)),void 0!==e&&""!==e&&e.replace(new RegExp(t,"g"),s)},TVMaze_View.prototype.loading=function(e){document.getElementById("loading").className=!0===e?"visible":"hidden"},TVMaze_View.prototype.error=function(e){document.getElementById("loading").style.display=!0===e?"block":"none",document.getElementById("loading-content").className=!0===e?"error":""};var TVMaze_Interface_Model_API=function(){this.baseQuery=null};TVMaze_Interface_Model_API.prototype.get=function(e,t){return e=this.baseQuery+e,(new TVMaze_API).get(e,t)};var TVMaze_Model_Episode=function(e,t,s){this.id=s.id,this.showId=e,this.seasonId=t,this.number=s.number,this.title=""!==s.name?s.name:s.number,this.images=s.image,this.premierDate=s.airDate,this.length=s.runtime,this.description=epsidoe.summary,this.baseQuery="seasons/"+this.seasonId+"/episodes/"+this.id+"/"},TVMaze_Model_Season=function(e,t){this.episodes=!1,this.id=t.id,this.showId=e,this.number=t.number,this.title=""!==t.name?t.name:t.number,this.premierDate=t.premierDate,this.endDate=t.endDate,this.description=t.summary,this.baseQuery="shows/"+this.showId+"/seasons/"+this.id+"/"};TVMaze_Model_Season.prototype.getEpisodes=function(i){var a=this;this.hasOwnProperty("episodes")&&!1!==this.episodes?i(this.episodes):!1===this.episodes&&TVMaze_Controller_Instance.api.get(this.baseQuery+"episodes",function(e,t){if(a.episodes=[],t&&0<t.length)for(var s=0;s<t.length;s++)a.seasons.push(new TVMaze_Model_Episode(a.showId,a.id,t[s]));i(a.episodes)})};var TVMaze_Model_Show=function(e){TVMaze_Interface_Model_API.call(this),this.seasons=!1,this.id=e.id,this.images=e.image,this.title=e.name,this.description=e.summary,this.status=e.status,this.rating=e.rating,this.premierDate=e.premiered?new Date(e.premiered):null,this.genre=e.genres&&0<e.genres.length?e.genres[0]:null,this.network=e.network,null!==this.premierDate&&(this.premierDate=this.premierDate.getMonth()+"/"+this.premierDate.getFullYear()),null===this.images&&(this.images={original:null,medium:null}),this.hasRating=void 0!==e.rating.average&&null!==e.rating.average?1:0,this.hasDescription=void 0!==e.summary?1:0,this.hasImage=null!==this.images.original?1:0,this.baseQuery="shows/"+this.id+"/"};TVMaze_Model_Show.prototype.getSeasons=function(i){var a=this;this.hasOwnProperty("seasons")&&!1!==this.seasons?i(this.seasons):!1===this.seasons&&TVMaze_Controller_Instance.api.get(this.baseQuery+"seasons",function(e,t){if(a.seasons=[],t&&0<t.length)for(var s=0;s<t.length;s++)a.seasons.push(new TVMaze_Model_Season(a.id,t[s]));i(a.seasons)})},TVMaze_Model_Show.prototype.getSeasonById=function(e){if(!this.hasOwnProperty("seasons")||0===this.seasons.length)return!1;var t=this.getItemByNameValue(this.seasons,"id",e);return t||!1};var containerID="tv-maze-container",TVMaze_Controller_Instance=new TVMaze_Controller({containerID:containerID,view:new TVMaze_View,api:new TVMaze_API});TVMaze_Controller_Instance.view.draw("view-index");